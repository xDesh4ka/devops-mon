# Мониторинг Docker-контейнеров с помощью Grafana и Prometheus

Задача: развернуть полноценный стек мониторинга Docker-контейнеров, включающий тестовое приложение, систему сбора метрик и визуализацию нагрузки в реальном времени.
## Необходимые компоненты
- **cAdvisor** — собирает метрики контейнеров (CPU, память, сеть, диск)​
- **Prometheus** — хранит и обрабатывает временные ряды метрик​
- **Grafana** — визуализирует данные через дашборды​
- **Тестовое приложение** — например, nginx или простое веб-приложение для генерации нагрузки

Мониторинг представляет собой непрерывный процесс сбора, агрегации, обработки и последующего анализа данных о состоянии и производительности систем в реальном времени, который позволяет системным администраторам и DevOps-инженерам получать детальное представление о работе инфраструктуры. 
В контексте контейнеризации, где приложения изолированы в легковесных виртуальных окружениях, мониторинг приобретает особую важность, поскольку позволяет отслеживать потребление критических ресурсов каждым отдельным контейнером — процессорного времени (CPU), оперативной памяти (RAM), сетевого трафика, операций дискового ввода-вывода (I/O), а также выявлять потенциальные проблемы на ранних стадиях до того момента, как они приведут к каскадным отказам или деградации производительности всей системы.

Внедрение комплексных систем мониторинга в производственные среды обусловлено несколькими критически важными факторами, которые напрямую влияют на надежность и эффективность работы контейнеризированных приложений:

- **Проактивная профилактика инцидентов и аномалий** — возможность раннего обнаружения утечек памяти (memory leaks), аномального потребления процессорных ресурсов, нестабильности сетевых соединений и других патологических состояний позволяет предотвратить критические сбои и минимизировать время простоя (downtime)

- **Оптимизация распределения вычислительных ресурсов** — детальное понимание паттернов потребления ресурсов различными контейнерами дает возможность эффективно планировать мощности (capacity planning), избегать избыточного выделения ресурсов (overprovisioning) и реализовывать стратегии горизонтального масштабирования (horizontal scaling)

- **Комплексная отладка и анализ производительности** — возможность анализировать поведение приложений под различными типами нагрузки, выявлять узкие места (bottlenecks) в архитектуре и оптимизировать критические участки кода на основе реальных метрик производительности

- **Обеспечение соответствия Service Level Agreements (SLA)** — гарантирование требуемых уровней доступности, времени отклика и пропускной способности сервисов через непрерывный контроль ключевых показателей производительности (KPI)

- **Ретроспективный аудит и расследование инцидентов** — сохранение исторических данных об использовании ресурсов позволяет проводить post-mortem анализ инцидентов, выявлять корневые причины (root cause analysis) и формировать базу знаний для предотвращения подобных ситуаций в будущем

## cAdvisor - агент сбора метрик контейнеров

**cAdvisor (Container Advisor)** представляет собой открытое решение от Google, специально разработанное для автоматического обнаружения и сбора детализированных метрик производительности всех запущенных контейнеров на хосте Docker, обеспечивая при этом минимальные накладные расходы на системные ресурсы. Архитектурно cAdvisor функционирует как демон-процесс, который осуществляет следующие важные операции:

- **Непрерывный сбор телеметрических данных** о потреблении процессорного времени (с детализацией до ядер CPU), использовании оперативной памяти (включая RSS, cache, swap), сетевом трафике (bytes transmitted/received, packets, errors), дисковых операциях ввода-вывода (read/write operations per second, throughput) для каждого запущенного контейнера на хосте

- **Предоставление RESTful API** на стандартном порту 8080, который обеспечивает программный доступ к собранным метрикам в структурированном формате JSON, позволяя интегрировать cAdvisor с внешними системами мониторинга и аналитики​

- **Экспорт метрик в формате Prometheus** — cAdvisor автоматически выставляет endpoint `/metrics`, который Prometheus может периодически опрашивать (scrape) для получения актуальных данных о состоянии контейнеров в формате time-series метрик​

- **Автоматическое обнаружение контейнеров** — cAdvisor динамически отслеживает жизненный цикл контейнеров, автоматически начиная сбор метрик при запуске новых контейнеров и прекращая при их остановке, что особенно важно в динамических средах с частым изменением состава контейнеров


## Prometheus - распределенная система мониторинга с временными рядами

**Prometheus** является многофункциональной открытой системой мониторинга и алертинга, изначально разработанной в компании SoundCloud и впоследствии принятой Cloud Native Computing Foundation (CNCF) в качестве одного из ключевых проектов для мониторинга облачных приложений. Prometheus представляет собой специализированную базу данных временных рядов (time-series database), оптимизированную для хранения и эффективного запроса метрик с временными метками, и реализует следующие архитектурные концепции:

- **Pull-based модель сбора метрик (scraping)** — в отличие от традиционных push-based систем, Prometheus самостоятельно инициирует периодические HTTP-запросы к источникам метрик по заранее определенному расписанию (обычно с интервалом 15-30 секунд), что обеспечивает централизованный контроль над процессом сбора данных и упрощает конфигурацию целевых систем

- **Эффективное хранение временных рядов** — Prometheus использует оптимизированную структуру хранения на диске с компрессией данных, что позволяет сохранять большие объемы метрик за длительные периоды времени при относительно небольших требованиях к дисковому пространству

- **Мощный язык запросов PromQL (Prometheus Query Language)** — специализированный функциональный язык запросов, предоставляющий богатые возможности для агрегации, фильтрации, математических операций и статистического анализа временных рядов, включая вычисление скоростей изменения (rate), процентилей, скользящих средних и других аналитических функций

- **Встроенная система правил алертинга** — Prometheus позволяет декларативно определять условия срабатывания алертов на основе PromQL-запросов, которые периодически вычисляются, и при выполнении заданных условий генерируют уведомления, передаваемые в систему Alertmanager для дальнейшей маршрутизации

- **Архитектура service discovery** — поддержка автоматического обнаружения целей мониторинга через интеграцию с различными системами оркестрации (Kubernetes, Docker Swarm, Consul) позволяет Prometheus динамически адаптироваться к изменениям в инфраструктуре без необходимости ручного обновления конфигурации

## Grafana: Платформа визуализации и анализа метрик

**Grafana** представляет собой мощную открытую платформу для создания интерактивных дашбордов визуализации метрик и реализации комплексных систем оповещения, которая обеспечивает единый интерфейс для доступа к данным из множества разнородных источников. Архитектурно Grafana реализует следующий набор возможностей:

- **Универсальный коннектор источников данных** — Grafana поддерживает подключение к широкому спектру систем хранения метрик (Prometheus, InfluxDB, Elasticsearch, MySQL, PostgreSQL и многие другие), позволяя создавать консолидированные дашборды с данными из различных источников на единой панели визуализации

- **Гибкая система создания интерактивных дашбордов** — визуальный редактор Grafana предоставляет богатый набор типов панелей (графики, гистограммы, тепловые карты, gauge-метры, таблицы, геокарты) с широкими возможностями настройки внешнего вида, масштабирования, аннотаций и интерактивных элементов управления

- **Расширенная система алертинга и нотификации** — начиная с версии 8.0, Grafana включает полностью переработанную систему Unified Alerting, которая позволяет создавать сложные правила на основе запросов к источникам данных и отправлять уведомления через множество каналов коммуникации (email, Slack, PagerDuty, Telegram, webhook и другие)​

- **Экосистема готовых дашбордов** — Grafana Labs поддерживает публичную библиотеку тысяч готовых дашбордов, созданных сообществом для популярных систем и приложений, которые можно импортировать одним кликом и адаптировать под собственные нужды

- **Система управления пользователями и permissions** — встроенная система авторизации и разграничения прав доступа позволяет организовывать коллективную работу над дашбордами, создавать отдельные организации (organizations) и команды (teams) с гранулярным контролем доступа к различным ресурсам


## Результат работы:

```
[Docker контейнеры с приложениями]
              ↓
    [cAdvisor — уровень сбора]
    Собирает низкоуровневые метрики из cgroups и namespaces
    Экспортирует метрики через HTTP endpoint в формате Prometheus
              ↓
   [Prometheus — уровень хранения и обработки]
   Периодически опрашивает cAdvisor и сохраняет метрики
   Предоставляет PromQL для запросов и агрегации
   Вычисляет правила алертинга
              ↓
    [Grafana — уровень визуализации]
    Выполняет запросы к Prometheus через datasource
    Строит интерактивные графики и дашборды
    Отправляет алерты через notification channels
```

### Запущенные контейнеры:
<img width="1235" height="177" alt="Снимок экрана 2025-12-03 в 00 08 17" src="https://github.com/user-attachments/assets/63a34c52-ff7a-4322-b714-0b36f65c2273" />

### Запущенный cAdvisor
<img width="1245" height="656" alt="Снимок экрана 2025-12-03 в 00 08 42" src="https://github.com/user-attachments/assets/7e2cb9ba-9493-4b32-b360-29157f9d8c53" />

### Prometheus с подключением к cAdvisor 
<img width="1241" height="474" alt="Снимок экрана 2025-12-03 в 00 08 57" src="https://github.com/user-attachments/assets/654becfa-aa4c-433b-a514-c9e8bc0d6763" />

### Сервер nginx/ваше web приложение
<img width="1244" height="654" alt="Снимок экрана 2025-12-03 в 00 09 20" src="https://github.com/user-attachments/assets/261d50d1-81fe-437c-a59b-262b18f2039a" />

### Рабочая панель в Grafana
<img width="1236" height="589" alt="Снимок экрана 2025-12-03 в 00 09 36" src="https://github.com/user-attachments/assets/b15a6737-7705-4c33-a198-9abd3d1e80e1" />


![[Снимок экрана 2025-12-02 в 23.35.39.png]]

## Этапы для выполнения задания
## Этап 1: Подготовка файлов конфигурации

1. Создайте новую директорию для проекта
2. Внутри создайте файл `docker-compose.yml` с определением всех сервисов (webapp, cadvisor, prometheus, grafana)
    - Убедитесь, что все контейнеры находятся в одной Docker-сети
    - Укажите правильные маппинги портов для каждого сервиса

3. Создайте файл `prometheus.yml` для конфигурации Prometheus    
    - Укажите, с какого источника собирать метрики (cAdvisor)
    - Установите интервал сбора метрик

## Этап 2: Запуск стека мониторинга

1. Запустите все контейнеры с помощью docker-compose
2. Проверьте, что все контейнеры работают (используйте команду `docker ps`)
3. Убедитесь, что нет ошибок запуска (проверьте логи контейнеров при необходимости)

## Этап 3: Проверка cAdvisor

1. Откройте веб-интерфейс cAdvisor в браузере
2. Убедитесь, что cAdvisor видит все контейнеры
3. Найдите в интерфейсе информацию о метриках контейнеров

## Этап 4: Проверка Prometheus

1. Откройте веб-интерфейс Prometheus
2. Перейдите в раздел Status → Targets
3. Проверьте, что target cAdvisor имеет статус UP
    - Если статус DOWN, проанализируйте ошибку в деталях
    - Проверьте конфигурацию `prometheus.yml` и сеть между контейнерами

4. Выполните тестовый запрос:
    - Перейдите на главную страницу Prometheus
    - В поле запроса введите метрику `container_cpu_usage_seconds_total`
    - Нажмите Execute и убедитесь, что выводятся данные
        
5. Если данных нет, проверьте:
    - Живой ли контейнер cAdvisor
    - Корректна ли сеть между Prometheus и cAdvisor
        

## Этап 5: Подключение Grafana к Prometheus

1. Откройте веб-интерфейс Grafana (логин/пароль: admin/admin)
2. Измените пароль администратора (рекомендуется)
3. Добавьте новый Data Source (источник данных):
    - Перейдите в Configuration → Data Sources
    - Нажмите Add data source
    - Выберите Prometheus
    - Укажите URL (внимание: используйте имя контейнера в Docker-сети, не localhost)
    - Нажмите Save & Test и убедитесь, что подключение работает

## Этап 6: Создание простого дашборда для тестирования

1. Создайте новый Dashboard (Home → Create → Dashboard)
2. Добавьте новую панель (Add new panel)
3. Используйте простой PromQL запрос для отображения метрики контейнера (например, использование CPU)
4. Установите временной диапазон на "Last 5 minutes"
5. Убедитесь, что на графике появляются данные
## Этап 7: Создание нагрузки на контейнер

1. Выполните команду для генерации нагрузки на контейнер webapp
2. Наблюдайте в реальном времени, как метрики изменяются на дашборде Grafana
3. Остановите нагрузку
4. Проанализируйте, как быстро метрики вернулись к норме
## Этап 8: Анализ и отчёт
1. Создайте скриншоты дашборда с метриками во время нормальной работы
2. Создайте скриншоты дашборда во время нагрузки
3. Опишите наблюдаемые изменения в метриках

---
## Инструкции по ходу выполнения

## Команды Docker Compose

## Веб-интерфейсы

|Сервис|URL|Назначение|
|---|---|---|
|cAdvisor|`http://localhost:8080`|Просмотр метрик контейнеров|
|Prometheus|`http://localhost:9090`|Выполнение PromQL запросов, проверка targets|
|Grafana|`http://localhost:3000`|Создание дашбордов и алертов|
|webapp (nginx)|`http://localhost`|Тестовое приложение|

## Проверка сетевого соединения между контейнерами

Если контейнеры не могут друг друга найти, используйте:

```bash
# Запуск всех контейнеров в фоне 
docker compose up -d 
# Проверка статуса контейнеров 
docker ps 
# Просмотр логов контейнера 
docker logs <имя_контейнера>
# Остановка всех контейнеров 
docker compose down 
# Перезапуск конкретного контейнера 
docker compose restart <имя_сервиса>
```

## Генерация нагрузки для тестирования

HTTP-запросы к nginx

```bash
# Выполнить 1000 запросов 
for i in {1..1000}; do curl http://localhost
```

## Синтаксис PromQL для популярных метрик

**CPU контейнера за последние 5 минут:**
`rate(container_cpu_usage_seconds_total{name="webapp"}[5m])`

**Использование памяти контейнером (в процентах):**
`(container_memory_usage_bytes{name="webapp"} / container_spec_memory_limit_bytes{name="webapp"}) * 100`

**Сетевой трафик (входящий) за последние 5 минут:**
`rate(container_network_receive_bytes_total{name="webapp"}[5m])`

**Проверка, что контейнер работает:**
`up{job="cadvisor"}`

## Отладка проблем
**Если Prometheus не видит cAdvisor:**
- Проверьте, что оба контейнера в одной сети: `docker network ls` и `docker network inspect <имя_сети>`
- Убедитесь, что имя хоста в конфиге Prometheus совпадает с именем контейнера cAdvisor
- Проверьте логи: `docker logs prometheus`

**Если Grafana не подключается к Prometheus:**
- В URL datasource используйте имя контейнера (`http://prometheus:9090`), а не localhost
- Проверьте, что Prometheus запущен и доступен из контейнера Grafana
- Убедитесь, что оба контейнера в одной Docker-сети
    

**Если в Grafana пусто на дашборде:**
- Проверьте Time Range (установите "Last 5 minutes")
- Убедитесь, что выбран правильный datasource (Prometheus)
- Проверьте корректность PromQL запроса вручную в Prometheus
- Убедитесь, что данные есть в Prometheus

## Полезные команды для диагностики

bash

```bash
# Список всех Docker-сетей
docker network ls

# Информация о сети
docker network inspect <имя_сети>

# Статистика использования ресурсов контейнером
docker stats <имя_контейнера>

# Вход в контейнер для выполнения команд
docker exec -it <имя_контейнера> /bin/sh
```
